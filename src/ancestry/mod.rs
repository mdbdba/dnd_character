/*
https://www.5esrd.com/races/ancestry-and-culture-an-alternative-to-races/

Ancestral and Cultural Traits
The description of each ancestry and culture includes both inherited and cultural traits that are
common to members of that ancestry or culture. The Age, Size, and Speed traits are tied to a
character’s ancestry, as these are most likely to be inherited traits, shared with biological
parents. The Alignment, Languages, Skills, and many other traits are tied to their culture, as
they do not depend on one’s biological parents as much as they do on the systems of belief and
practices of the community of one’s upbringing. Each entry distinguishes between them clearly.

For example, a dwarf who grows up among other dwarves would possess all of the traits from both
dwarf ancestry and dwarven culture, whereas an elf who grew up among dwarves would possess elf
ancestral traits, such as Keen Senses, Fey Ancestry, and Trance, but dwarven cultural traits,
such as Combat Training, Tool Proficiency, Stonecunning, and proficiency in the Dwarvish language.

Weapon training and languages aren’t genetic, after all; one learns them from one’s family and
community. Thus, if an elf grew up in dwarven culture, they would learn dwarven weapon training
and languages, unless those who raised them specifically chose to raise them as culturally elven.

Ability Scores as Culture, not Ancestry?
Some readers may wonder why ability score increases appear in culture rather than ancestry. This
choice allows us to move away from the problematic notion certain ethnic groups have higher
strength or intelligence, as those notions are often at the heart of racist attitudes in the
real world. And rather than removing ability score increases entirely, or dividing them up in
some more complex way such as a point buy system, these rules keep them under the umbrella of
culture for simplicity and ease of use.

Age
The age entry notes the age when a member of an ancestry is considered an adult, as well as the
ancestry’s expected lifespan. This information can help you decide how old your character is at
the start of the game. You can choose any age for your character, which could provide an
explanation for some of your ability scores. For example, if you play a young or very old
character, your age could explain a particularly low Strength or Constitution score, while
advanced age could account for a high Intelligence or Wisdom.

Alignment
Ancestries have no innate alignments whatsoever, as behavioral tendencies toward goodness or
chaos or law or evil are not genetically inherited. Cultures are not straightforwardly good or
evil either, though values are indeed often a part of a culture’s belief systems. Even so, those
values could never be reduced to simple concepts like goodness, evil, law, or chaos. What’s more,
such cultural beliefs do not dictate the beliefs of an individual character, though some cultural
norms might weakly influence an individual’s alignment, though it is up to the player whether
such influences are present or if they instead reject them.

Nevertheless, some general cultural influences are described in this entry, with weak tendencies
toward particular values described, so that players might have a sense of the various cultures
they may choose and because they are familiar to players of the game. These are not binding for
player characters; they are included only to give players a sense of what their character’s chosen
culture is like, though some of the more problematic descriptions have been removed or revised.

Indeed, players may even decide to drop alignment completely, as it plays very little mechanical
role in the game and is overly simplistic in many ways. It has been included here only so that
players looking for it see that, if it must be retained, it is better attributed to culture
than biology.

Size
Characters of most ancestries are Medium, a size category including creatures that are roughly
4 to 8 feet tall. Members of a few ancestries are Small (between 2 and 4 feet tall), which means
that certain rules of the game affect them differently. Please note that the Size recommendations
listed here are always modifiable. For example, you may wish for your character to be a human,
elf, dragonborn, or orc little person, in which case you might prefer your character be
Small rather than Medium.

Speed
Your speed determines how far you can move when traveling and fighting.

Languages
By virtue of your culture, your character can speak, read, and write certain languages.

Mixed Ancestry and Diverse Culture
The ancestry and culture options above assume that a character has a single ancestry and culture.
Thus, if a character has elven ancestry, this assumes that their ancestry is primarily elven.
Most commonly, this would mean that both of their parents are of elven ancestry.

Some characters have mixed ancestries, however. For example, a character can have an elven parent
and a human parent, or a dwarven parent and a halfling parent. Other characters can have parents
who themselves have mixed ancestry.

The rules in this section provide mechanics to generate such mixed ancestries.

Of course, almost all characters in a fantasy world probably have some degree of mixed ancestry.
These rules are intended to allow players to make characters that have two primary ancestries,
however, rather than one dominant one.

Finally, rules for creating diverse cultures follow the rules for mixed ancestries.

Diverse cultures represent those that are a combination of several cultures, as one might find
in a multicultural urban environment.

Mixed Ancestral Traits
Your character has inherited qualities from biological parents of two or more ancestries. Perhaps
your parents are an elf and a human, a halfling and a gnome, an elf and a dwarf, or one or both
are themselves of mixed ancestry. Regardless, your ancestries provide you certain inherited
characteristics. In addition, you may have traits that are unique to children who claim more
than one ancestry.

Characters of mixed ancestry might look almost entirely like one parent or the other, or anywhere
on the continuum between them. Thus the two children of a dwarf–tiefling couple might both look
tiefling, dwarven, some combination, or one might look tiefling and the other dwarven, even
though they are siblings.

Age. Pick two of your ancestries from the available options. Select a number in between the two
ages listed for when people of those ancestries come of age, and again between the numbers listed
for their average lifespans. Write these down; these are your age at which you became an adult and
your expected lifespan.

Size. Pick the listed size from your chosen ancestries and choose one of the sizes listed. If both
of your ancestries are size Medium, then so are you. If both are Small, then likely so are you.
If both Small and Medium sizes appear in your chosen ancestries, you may choose which size you are.

Speed. Your base walking speed is 30 feet, unless both of your chosen ancestries have a base speed
of 25 feet, or your size is Small, in which case your base walking speed is 25 feet.

Darkvision. As long as one of your ancestries has the Darkvision trait, you may have darkvision
as well, if you choose.

Additional Ancestral Traits. You may select one other ancestral trait from each of your two
chosen ancestries. For example, you might select Fey Ancestry from an elven ancestor, or Hellish
Resistance from a tiefling ancestor. If you have a dragonborn ancestor, you may select Draconic
Ancestry and either the Breath Weapon trait or the Damage Resistance trait, but not both.

A Note on Balance
Some players may have concerns that the various ancestries and cultures here are not perfectly
balanced. What’s more, a certain kind of player might try to use these rules to make a more
powerful ancestry and culture combination than other players have. To be sure, these ancestries
and cultures are not perfectly balanced.

Then again, the original races are not perfectly balanced either, yet this has not broken the game
or caused all players to use the same few slightly more optimized races.

Allowing players to mix and combine ancestries and cultures is primarily valuable for narrative,
rather than mechanics, but these options have been created with mechanical balance in mind as well.
As always, you can discuss with your players if you wish to adapt the rules for your table.

Diverse Cultural Traits
People of mixed ancestries are most often found in multicultural communities where elves, humans,
dwarves, and halflings, among others, live together. Anyone of any ancestry can be found in such
communities, which is one of the strengths of such cultures.

Ability Score Increase. Your Charisma score increases by 2, and two other ability scores of your
choice increase by 1.

Alignment. Those who grow up in such diverse cultures often share a pluralistic and open-minded
bent. They value both personal freedom and creative expression, demonstrating neither love of
leaders nor desire for followers.

Skill Versatility. You gain proficiency in two skills of your choice.

Languages. You can speak, read, and write Common and two extra languages of your choice that might
be spoken in your community.

Appendixes
Below are some additional rules, options, and resources for replacing race in your favorite
fantasy roleplaying game.

Appendix A: Personalized, Anti-Essentialist Culture
The rules above reject the essentialist concept of race, which supposes that your biological
ancestry determines your personality and abilities. They instead assign many of those features
to one’s culture, particularly those that refer to skills and alignment. However, you might not
like the somewhat essentialist picture this paints of culture; after all, do we want to say that
simply because you grew up among orcs, you are somewhat more likely to be strong or athletic?
Do we want to assign any traits at all, uniformly, to a culture?

It might be reasonable to say yes, if the orcish communities in a setting simply have a more
physically oriented education curriculum for their young people.

Similarly, elvish communities might have their children study a simple cantrip or the use of the
longbow. This may not, at a glance, seem problematic to some people.

Even so, if you would like to avoid even this hint of cultural essentialism, you have another
option, one that can allow you to retain elements of cultural representation while adjusting
them to your liking. What’s more, you can retain or jettison whichever elements of the culture
concepts presented above that you prefer.

For example, perhaps your character grew up in a traditional orcish community, but she was the
child of the village scribe, so she has a +2 to Intelligence rather than Strength. Or maybe you
are of gnomish ancestry and grew up among gnomes, but you chose to become a gnomish wrestler, and
so have a +2 to Constitution rather than Intelligence. After all, in every culture, one can find
a vast variety of interests, personalities, and professions.

The option below allows you to personalize any culture. To use it, describe what ancestries are
found in this culture, then select the traits below, as usual.

Combine this with one of the ancestry options above to customize your character even more.

Personalized Cultural Traits
Ability Score Increase. One ability score of your choice increases by 2, and another ability score
of your choice increases by 1.

Alignment. What alignment your character adopts is entirely independent of your ancestry or
culture and, as such, is a personal choice.

Personalized Proficiencies. You gain proficiency in two skills of your choice.

Languages and Tools. You can speak, read, and write Common. You have proficiency with one tool
of your choice and speak one extra language that might be spoken in your community.

Other Races
The rules contained in this document refer only to the races and subraces available under
the Open Gaming License. Fortunately, you can use the principles in this document with other
races and subraces in your favorite roleplaying game. The following process allows you to
replace any race with a corresponding ancestry and culture.

Step 1: Identify Ancestral Traits
Only traits that could only be biologically inherited belong in this category.

These include things like age, darkvision, size, and speed. Other traits that seem biological,
such as resistances (like tieflings’ resistance to fire or dwarves’ resistance to poison) might
belong here as well. In the above examples, we also opted to include a few traits that grant
advantage on certain saves, such as Fey Ancestry and Gnome Cunning, since these may be a result
of magical ancestry rather than upbringing.

Ancestry might include physical traits like wings, claws, horns, gills, long limbs, powerful
builds, or natural armor. Other unique bodily features also fall into this category, such as the
ability to mimic sounds or change shape.

Beyond these obvious bodily features, most other racial traits—both from the Open Gaming License
and from other races—can be ascribed to culture rather than ancestry.

Step 2: Identify Cultural Traits
Any trait that concerns a skill or magical talent can usually be attributed to a creature’s
culture. These include language proficiencies, skill and tool proficiencies, and any form of
training with weapons or armor. Some examples in the rules above are Dwarven Combat Training,
Elven Weapon Training, or the orcish Powerful Attack, which suggests a style of combat that is
reasonably understood as having been learned.

In the above rules, magical skills and talents are included this category, such as an elf’s
cantrip and a tiefling’s ability to cast thaumaturgy or darkness. Some might balk at this,
suggesting that these abilities are innate biological inheritances, like a dragonborn’s breath
weapon. Though this may be reasonable, it’s also reasonable to assume that such magical talents
require training and that elves or tieflings who grow up outside their own cultures may not learn
to harness these abilities. Conversely, it may be odd to say that someone of dwarven or halfling
ancestry could learn a cantrip from being raised among elves or the darkness spell from growing up
in a tiefling community, but we would rather ascribe as many traits as possible to culture to
avoid biological essentialism, as well as to avoid making some ancestries more mechanically
powerful than others.

Next, ascribe any ability score increases to culture. This may be controversial to some who
imagine that all dwarves have a high Constitution, for example, or that all orcs are naturally
strong. And to some extent, a few biologically inherited traits remain a part of these ancestries,
including Dwarven Toughness and orcs’ Relentless Endurance. Nevertheless, increased Strength or
Intelligence simply cannot occur without experience. Even if we were to suppose that orcs possess
a slight genetic disposition toward Strength or gnomes toward Intelligence, individuals who do
not exercise or study will not develop those supposedly inborn traits. In other words, simply
being of orcish or gnomish ancestry is not sufficient to grant ability score increases. Thus, they
are best suited to come from culture, since that is where education, training, and experience occur.

Step 3: Check for Balance
Once you have divided up the standard racial traits and assigned them to either ancestry or
 culture, evaluate them for balance. Ideally, the traits from the original race divide equally
 between ancestry and culture. Try to allocate traits to both ancestry and culture so as to make
 either a desirable mechanical choice. Though many players choose their character’s ancestry and
 culture based on roleplay and backstory motives, it’s helpful to balance the mechanical
 advantages so that they are perceived as equally viable, with no one ancestry or culture clearly
 more powerful than the others.

Congratulations! You have now transformed the outdated race category in your favorite fantasy
roleplaying game into the less problematic and more flexible categories of ancestry and culture!

On complexity versus Ease of Use

Some players might prefer to choose traits from a menu so they can exactly specify their
character’s traits. These rules avoid such an approach, for two reasons. First, point buy ‘race’
building systems are so much more complex as to be prohibitive. One goal of these rules is to
encourage as many tables as possible to remove racial essentialism from their fantasy gaming,
so these rules should be as simple as possible, requiring only two simple choices rather than
one. Second, spending a pool of points by choosing ‘racial’ traits from a menu robs ‘races’,
ancestries, and cultures of narrative value. If every elf, dwarf, and halfling can have literally
any of the fantasy traits, from wings, to darkvision, to fey ancestry, to halfling nimbleness,
in what sense do these categories have any narrative purpose at all? This approach is certainly
an option, but doing so robs the fantasy worlds in which we play of a rich narrative resource
which many players would miss.

Alternative Ancestry

Ancestry is the term that we will be using to represent the different species and cultures that
exist within your fantasy setting. The term ‘race’ as it is traditionally used in fantasy RPGs is
both inaccurate and problematic and carries a lot of issues along with it.

The idea of a person’s race carrying innate truths about a person’s aptitude, alignment, and
nature are based on racist beliefs. In this book, we are redesigning ancestries not only to have
a simple, streamlined system, but also to remove some of the problematic elements that have
persisted in fantasy Rpgs for a long time.

Here are some elements of the core rules that experience a significant change in these rules.

Changes to Ability Score Bonuses
One of the biggest issues that most fantasy Rpgs have is assigning predetermined ability score
changes based on a character’s race. The implications that certain people are smarter or stronger
than others because of their racial background are problematic.

From a game design perspective, it pigeonholes characters into certain roles, which limits
creativity and often creates a negative feedback loop. Why don’t you traditionally see barbarian
halflings? Because the game rules don’t support that kind of character. If someone does utilize
that combination, they have to work harder than other characters to overcome the same challenges,
which leads to fewer people picking that combination. Instead, all ancestries give players the
same choice. When you select your ancestry, you can assign a +2 and +1 bonus to two different
ability scores of your choice, or +1 to three different ability scores of your choice.

Every ancestry gets this option, and every ancestry gets the same amount of ability score
increases to spend. From a game design perspective, every ancestry having the same amount of
ability score increases mean that you can focus on creating unique features to differentiate
your characters, instead of your ability score increases.

Where is Alignment?
The concept that certain people have a tendency towards a certain alignment is bogus. Pick
whatever alignment you want. Or, better yet, just ditch alignment altogether.

Major/Minor Feature System
Every ancestry here is built with the following basic framework:

Two major features
Two minor features
One major feature can be exchanged for two additional minor features.

The major and minor features replace the traits that a race in 5e would receive. Instead of
every character of the same ancestry having the exact same traits, as is depicted in the base
rules, you can better represent the variety of cultures and physical traits an ancestry might
encompass with this system.

About Ancestry Entries
The basic foundation that goes into creating an ancestry is this:

Each ancestry has the same ability score increases to assign.
An ancestry’s size and speed are predetermined, and there is little effect from them. A character
who is Small typically has a speed of 25 feet, and a Medium sized character typically has a speed
of 30 feet. The advantages and disadvantages for being Small sized pretty much cancel each other
out, and the difference in speed between 25 feet and 30 feet is extremely minor.
An ancestry gains two languages by default, typically common and one additional language. Where
appropriate we’ve selected a common second language, but that can be changed to any other language.
Each ancestry is built with two major features and two minor features, or one major feature and
four minor features. These are either chosen from a pre-selected list by the player, predetermined
based on the ancestry’s biology, or put into subtype packages where there are significant physical
differences between subtypes of an ancestry.
Any ancestry can have any name. Some of the suggested names have been submitted by the backers
of this project.

Class Features
To determine if a listed feature is a major or minor feature, you can use the following legend.

(Major Feature): Major feature
(Minor Feature): Minor feature
For example, a feature with (Major Feature) would be considered a major feature. If a trait is
listed under a major or minor feature list, it won’t have (Major Feature) or (Minor Feature),
since it’s already specified what kind of feature it is.

Tags
Certain features have a tag, or a word in parenthesis like (magic) or (transformation). In general,
a character can’t have two features with the same tag. For example, you can’t have two features
with the (magic) tag.

Balance
Throughout this book, we’ve chosen to focus on simplicity instead of granularity. For example, we
made the decision that resistance to a non-physical damage type (acid, cold, fire, etc.) would be
a minor feature.

In truth, some damage types are more common than others, and therefore theoretically more
valuable. Resistance to fire damage, for example, is likely to yield greater results than
resistance to force or radiant damage, which are quite rare in most cases.

The type of game setting you play in could also affect the balance of the features presented. If
you play a game where firearms or ranged weapons are common, or the players are constantly
underground in tight tunnels, then flight might not be as useful.

Feel free to adjust the balance of Ancestry Awakened to best fit your game. You could decide that
flight is only worth one major feature in your setting, instead of two. Or perhaps darkvision is
important enough that you want to bump it up to a major feature.

Or maybe you just want everyone to have more options, and you allow everyone to have three minor
features instead of the standard two.

With Ancestry Awakened, every ancestry is built on the same framework. So deciding to give
everyone additional features makes all of the players equally stronger.

Half Ancestries
Characters from two different ancestries can have children that possess features from both
ancestries. Half-elves and half-orcs are the most commonly portrayed in fantasy Rpgs, but that
doesn’t mean there can’t be other combinations. You can replicate a character descended from
two different ancestries with the following rule.

Take one major and one minor feature each from two different ancestries.
This easily replicates receiving traits from two different ancestries, or the lessons the
character learned growing up within different cultures.

Make sure to work with your GM to decide what combinations are possible or logical in your setting.

Half ancestries should generally be used for unique or interesting story opportunities, and not
as a way of collecting a specific combination of traits. Ancestry Awakened is not balanced around
every potential combination of features, and we expect the players and GM to work together to
make sure that everyone is having a fun time.

Using these Ancestries
The goal with the new ancestries is to provide you with options and reworked lore for playing
these characters. If you want to play as a troll, we’ve introduced information that presents
trolls as people with their own unique culture and background. If your world doesn’t have trolls,
you don’t need to add them just because this book has them.

This lore in these rules doesn’t need to replace the lore you have for trolls either. It’s
entirely possible for different groups of trolls to have developed separate, unique cultures.
Just remember not to make one group of people inherently evil. That’s boring and often has
racist connotations.

The people that make up an ancestry come from different backgrounds and have different cultures.
Not every dwarf is going to have a Scottish accent and gruff demeanor. A group of dwarves that
grew up near the ocean might have settled on the beaches, eventually growing away from the
traditions that their underground-dwelling brethren have. When you decide to use one of these
ancestries, or create your own, think about the different cultures this ancestry might contain,
instead of just a single monoculture. Doing so will enrich your setting and make it feel more
alive and dynamic.
*/

mod dragonborn;
mod dwarf;
mod elf;

use crate::ancestry::dragonborn::{new_dragonborn_ancestry, new_dragonborn_culture};
use crate::ancestry::dwarf::{new_dwarven_ancestry, new_dwarven_culture};
use crate::character::{
    get_damage_type, get_vantage, CharacterAbility, CharacterPreferences, DamageType,
    MechanicCategory, MechanicLevel, Vantage,
};
use crate::modifier::Modifier;
use crate::roll::roll_die;
use rand::prelude::SliceRandom;
use rand::Rng;
use std::clone::Clone;
use std::collections::HashMap;

pub fn get_lc_some_value(src: Option<String>, default: String) -> String {
    let return_value;
    if let Some(value) = src.clone() {
        return_value = value.to_lowercase();
    } else {
        return_value = default.clone();
    }
    return_value
}

pub fn get_i16_some_value(src: Option<i16>, default: i16) -> i16 {
    let return_value;
    if let Some(value) = src.clone() {
        return_value = value;
    } else {
        return_value = default.clone();
    }
    return_value
}

pub struct BaseAncestralTraits {
    name: String,
    parent_name: String,
    maturity_age: i16,
    avg_max_age: i16,
    base_walking_speed: i16,
    height_min_inches: i16,
    height_modifier_multiplier: i16,
    height_modifier_die: i16,
    height_modifier_adj: i16,
    weight_min_pounds: i16,
    weight_modifier_multiplier: i16,
    weight_modifier_die: i16,
    weight_modifier_adj: i16,
    base_size: String,
    skin_tones: Vec<String>,
    hair_colors: Vec<String>,
    hair_types: Vec<String>,
    eye_colors: Vec<String>,
    abilities: HashMap<String, HashMap<String, CharacterAbility>>,
    source_material: String,
    source_credit_url: String,
    source_credit_comment: String,
}

pub fn get_parent_ancestry(src: String) -> String {
    return match src {
        _ if src.contains("half-elf") => String::from("half-elf"),
        _ if src.contains("half-orc") => String::from("half-orc"),
        _ if src.ends_with(" dragonborn") || src.contains("dragonborn") => {
            String::from("dragonborn")
        }
        _ if src.ends_with(" dwarf") || src.contains("dwarf") => String::from("dwarf"),
        _ if src.ends_with(" elf") || src.contains("elf") => String::from("elf"),
        _ if src.ends_with(" halfling") || src.contains("halfling") => String::from("halfling"),
        _ if src.ends_with(" human") || src.contains("human") => String::from("human"),
        _ if src.ends_with(" gnome") || src.contains("gnome") => String::from("gnome"),
        _ if src.contains("tiefling") || src.contains("tiefling") => String::from("tiefling"),
        _ => String::from("human"),
    };
}

impl BaseAncestralTraits {
    pub fn get_name(&self) -> String {
        self.name.clone()
    }

    pub fn get_parent_name(&self) -> String {
        self.parent_name.clone()
    }
    pub fn get_age(&self) -> i16 {
        let mut rng = rand::thread_rng();
        rng.gen_range(self.maturity_age..self.avg_max_age + 1)
            .clone()
    }
    pub fn get_height(&self) -> i16 {
        roll_die(
            self.height_modifier_die,
            self.height_modifier_multiplier,
            Modifier::None,
            self.height_min_inches + self.height_modifier_adj,
        )
        .get_total()
        .clone()
    }
    fn get_weight(&self) -> i16 {
        roll_die(
            self.weight_modifier_die,
            self.weight_modifier_multiplier,
            Modifier::None,
            self.weight_min_pounds + self.weight_modifier_adj,
        )
        .get_total()
        .clone()
    }

    fn get_base_walking_speed(&self) -> i16 {
        self.base_walking_speed.clone()
    }
    fn get_base_size(&self) -> String {
        self.base_size.clone()
    }

    fn get_skin_tone(&self) -> String {
        get_random_string(self.skin_tones.clone(), "wonderful".to_string())
    }
    fn get_hair_color(&self) -> String {
        get_random_string(self.hair_colors.clone(), "wonderful".to_string())
    }
    fn get_hair_type(&self) -> String {
        get_random_string(self.hair_types.clone(), "wonderful".to_string())
    }
    fn get_eye_color(&self) -> String {
        get_random_string(self.eye_colors.clone(), "wonderful".to_string())
    }
    pub fn get_saving_throw(
        name: String,
        vantage: Vantage,
        damage_type: DamageType,
    ) -> CharacterAbility {
        let ability_vantage = get_vantage(vantage);
        let mech_enum_value: MechanicCategory;
        if ability_vantage == "advantage" {
            mech_enum_value = MechanicCategory::Advantage;
        } else {
            mech_enum_value = MechanicCategory::Disadvantage;
        }
        let ability_damage_type = get_damage_type(damage_type);
        CharacterAbility {
            ability_name: name,
            category: ability_vantage.clone(),
            specific_effect: vec![ability_damage_type],
            range: vec!["all".to_string()],
            mechanic: vec![MechanicLevel {
                level: 1,
                effect_range: None,
                category: mech_enum_value,
            }],
            availability: vec!["always".to_string()],
        }
    }
    pub fn get_darkvision(range: Option<Vec<String>>) -> CharacterAbility {
        let ability_range;
        if let Some(value) = range {
            ability_range = value.clone();
        } else {
            ability_range = vec!["60 feet".to_string()];
        }
        CharacterAbility {
            ability_name: "darkvision".to_string(),
            category: "environmental".to_string(),
            specific_effect: vec!["dim light".to_string(), "dark".to_string()],
            range: ability_range,
            mechanic: vec![MechanicLevel {
                level: 1,
                effect_range: None,
                category: MechanicCategory::Sight,
            }],
            availability: vec!["always".to_string()],
        }
    }
    pub fn add_resistances(src: Vec<String>) -> HashMap<String, CharacterAbility> {
        let mut resistances: HashMap<String, CharacterAbility> = HashMap::new();
        for res in src {
            resistances.insert(
                res.clone(),
                CharacterAbility {
                    ability_name: "damage resistance".to_string(),
                    category: "damage".to_string(),
                    specific_effect: vec![res.clone()],
                    range: vec!["all".to_string()],
                    // mechanic: vec! {"half damage".to_string()},
                    mechanic: vec![MechanicLevel {
                        level: 1,
                        effect_range: None,
                        category: MechanicCategory::HalfDamage,
                    }],
                    availability: vec!["always".to_string()],
                },
            );
        }
        resistances
    }
    pub fn add_immunities(src: Vec<String>) -> HashMap<String, CharacterAbility> {
        let mut immunities: HashMap<String, CharacterAbility> = HashMap::new();
        for res in src {
            immunities.insert(
                res.clone(),
                CharacterAbility {
                    ability_name: "damage immunity".to_string(),
                    category: "damage".to_string(),
                    specific_effect: vec![res.clone()],
                    range: vec!["all".to_string()],
                    // mechanic: vec! {"no damage".to_string()},
                    mechanic: vec![MechanicLevel {
                        level: 1,
                        effect_range: None,
                        category: MechanicCategory::NoDamage,
                    }],
                    availability: vec!["always".to_string()],
                },
            );
        }
        immunities
    }
}

pub fn get_random_string(strings: Vec<String>, default: String) -> String {
    let mut rng = rand::thread_rng();
    strings.choose(&mut rng).cloned().unwrap_or(default)
}

pub struct AncestralTraits {
    pub name: String,
    pub parent_name: String,
    pub age: i16,
    pub base_walking_speed: i16,
    pub height: i16,
    pub weight: i16,
    pub base_size: String,
    pub skin_tone: String,
    pub hair_color: String,
    pub hair_type: String,
    pub eye_color: String,
    pub abilities: HashMap<String, HashMap<String, CharacterAbility>>,
    pub source_material: String,
    pub source_credit_url: String,
    pub source_credit_comment: String,
}

impl AncestralTraits {
    pub fn new(prefs: &mut CharacterPreferences) -> AncestralTraits {
        let name = prefs.ancestry.clone();

        let anc = get_parent_ancestry(name);
        let ancestry_name = &anc[..];

        return match ancestry_name {
            "dragonborn" => new_dragonborn_ancestry(prefs),
            "dwarf" => new_dwarven_ancestry(prefs),
            _ => new_dragonborn_ancestry(prefs),
        };
    }
    fn combiner(prefs: &mut CharacterPreferences, base_values: &BaseAncestralTraits) {
        if let Some(value) = prefs.age {
            if value < 1 || value > (base_values.avg_max_age + 40) {
                prefs.age = Some(base_values.get_age());
            }
        } else {
            prefs.age = Some(base_values.get_age());
        }
        if let Some(value) = prefs.height {
            if value < base_values.height_min_inches
                || value
                    > (base_values.height_min_inches
                        + (base_values.height_modifier_multiplier
                            * base_values.height_modifier_die)
                        + 12)
            {
                prefs.height = Some(base_values.get_height());
            }
        } else {
            prefs.height = Some(base_values.get_height());
        }
        if let Some(value) = prefs.weight {
            if value < base_values.weight_min_pounds
                || value
                    > (base_values.weight_min_pounds
                        + (base_values.weight_modifier_multiplier
                            * base_values.weight_modifier_die)
                        + 50)
            {
                prefs.weight = Some(base_values.get_weight());
            }
        } else {
            prefs.weight = Some(base_values.get_weight());
        }

        if let Some(value) = prefs.skin_tone.clone() {
            prefs.skin_tone = Some(value.to_lowercase());
        } else {
            prefs.skin_tone = Some(base_values.get_skin_tone());
        }
        if let Some(value) = prefs.hair_color.clone() {
            prefs.hair_color = Some(value.to_lowercase());
        } else {
            prefs.hair_color = Some(base_values.get_hair_color());
        }
        if let Some(value) = prefs.hair_type.clone() {
            prefs.hair_type = Some(value.to_lowercase());
        } else {
            prefs.hair_type = Some(base_values.get_hair_type());
        }
        if let Some(value) = prefs.eye_color.clone() {
            prefs.eye_color = Some(value.to_lowercase());
        } else {
            prefs.eye_color = Some(base_values.get_eye_color());
        }
    }
}

pub fn set_alignments(
    lg: i16,
    ng: i16,
    cg: i16,
    ln: i16,
    tn: i16,
    cn: i16,
    le: i16,
    ne: i16,
    ce: i16,
) -> HashMap<String, i16> {
    [
        ("lawful good".to_string(), lg),
        ("neutral good".to_string(), ng),
        ("chaotic good".to_string(), cg),
        ("lawful neutral".to_string(), ln),
        ("true neutral".to_string(), tn),
        ("chaotic neutral".to_string(), cn),
        ("lawful evil".to_string(), le),
        ("neutral evil".to_string(), ne),
        ("chaotic evil".to_string(), ce),
    ]
    .iter()
    .cloned()
    .collect()
}

pub fn set_ability_bonuses(s: i8, d: i8, cn: i8, i: i8, w: i8, ch: i8) -> HashMap<String, i8> {
    [
        ("strength".to_string(), s),
        ("dexterity".to_string(), d),
        ("constitution".to_string(), cn),
        ("intelligence".to_string(), i),
        ("wisdom".to_string(), w),
        ("charisma".to_string(), ch),
    ]
    .iter()
    .cloned()
    .collect()
}

pub struct LanguageTraits {
    pub name: String,
    pub can_speak: bool,
    pub can_read: bool,
    pub can_write: bool,
}

pub struct BaseCulturalTraits {
    pub alignments: HashMap<String, i16>,
    pub ability_bonuses: HashMap<String, i8>,
    pub tool_proficiency_choices: Option<Vec<String>>,
    pub abilities: HashMap<String, HashMap<String, CharacterAbility>>,
}
impl BaseCulturalTraits {
    pub fn get_alignment(&self) -> String {
        let mut rng = rand::thread_rng();
        let mut sum = 0;
        for (_, chance) in &self.alignments {
            sum += chance;
        }
        let random_num = rng.gen_range(1..101);
        for (name, chance) in &self.alignments {
            if random_num <= chance + sum {
                return name.clone();
            }
            sum += chance;
        }
        String::from("true neutral")
    }
    pub fn add_languages(src: Vec<LanguageTraits>) -> HashMap<String, CharacterAbility> {
        let mut languages: HashMap<String, CharacterAbility> = HashMap::new();
        for lt in src {
            let mut modes: Vec<String> = Vec::new();
            if lt.can_speak == true {
                modes.push("speak".to_string())
            }
            if lt.can_read == true {
                modes.push("read".to_string())
            }
            if lt.can_write == true {
                modes.push("write".to_string())
            }
            let ability1 = CharacterAbility {
                ability_name: "ancestral language".to_string(),
                category: "language".to_string(),
                specific_effect: vec![lt.name.clone()],
                range: modes,
                // mechanic: vec! {"none".to_string()},
                mechanic: vec![MechanicLevel {
                    level: 1,
                    effect_range: None,
                    category: MechanicCategory::Language,
                }],
                availability: vec!["always".to_string()],
            };
            languages.insert(lt.name.clone(), ability1);
        }
        languages
    }
}

pub struct CulturalTraits {
    pub name: String,
    pub parent_name: String,
    pub alignment: String,
    pub ability_bonuses: HashMap<String, i8>,
    pub abilities: HashMap<String, HashMap<String, CharacterAbility>>,
    pub source_material: String,
    pub source_credit_url: String,
    pub source_credit_comment: String,
}
impl CulturalTraits {
    pub fn new(prefs: &mut CharacterPreferences) -> CulturalTraits {
        let cul = get_parent_ancestry(prefs.ancestry.clone());
        let culture_name = &cul[..];

        return match culture_name {
            "dragonborn" => new_dragonborn_culture(prefs),
            "dwarf" => new_dwarven_culture(prefs),
            _ => new_dragonborn_culture(prefs),
        };
    }
    pub fn combiner(prefs: &mut CharacterPreferences, base_values: &BaseCulturalTraits) {
        if let Some(value) = prefs.alignment.clone() {
            let alignment_string = match value.to_lowercase().as_str() {
                "lawful good" => "lawful good".to_string(),
                "good" | "neutral good" => "neutral good".to_string(),
                "chaotic good" => "chaotic good".to_string(),
                "lawful neutral" => "lawful neutral".to_string(),
                "neutral neutral" | "neutral" | "true neutral" => "true neutral".to_string(),
                "chaotic neutral" => "chaotic neutral".to_string(),
                "lawful evil" => "lawful evil".to_string(),
                "evil" | "neutral evil" => "neutral evil".to_string(),
                "chaotic evil" => "chaotic evil".to_string(),
                _ => base_values.get_alignment(),
            };
            prefs.alignment = Some(alignment_string)
        } else {
            prefs.alignment = Some(base_values.get_alignment());
        }
    }
}

#[cfg(test)]
mod tests {
    use crate::ancestry::{BaseAncestralTraits};
    //use crate::character::{CharacterPreferences, get_vantage, MechanicCategory, Vantage};

    #[test]
    fn test_add_immunities() {
        let immunities =
            BaseAncestralTraits::add_immunities(vec!{"poison".to_string()});
        assert_eq!(immunities.len(), 1)
    }
}







/*



Gnome
Some scholars in gnomish culture recount tales of gnomes shaped from ancient, magical gems,
perhaps with the aid of a god. Gem crafting is a skill valued in gnomish culture to this day.

Contents [show]

Ancestral Traits
Your gnome character has certain characteristics in common with all other gnomes.

Age. Gnomes mature at the same rate humans do, and most are expected to settle down into an adult
life by around age 40. They can live 350 to almost 500 years.

Size. Gnomes are between 3 and 4 feet tall and average about 40 pounds. Your size is Small.

Speed. Your base walking speed is 25 feet.

Darkvision. Your ancestors were accustomed to life underground. You have superior vision in dark
and dim conditions. You have superior vision in dark and dim conditions. You can see in dim light
within 60 feet of you as if it were bright light, and in darkness as if it were dim light. You
can’t discern color in darkness, only shades of gray.

Gnome Cunning. You have advantage on all Intelligence, Wisdom, and Charisma saving throws
against magic.

Cultural Traits
Rock Gnome
Rock gnomish culture and education tend to promote cleverness and ingenuity, qualities that produce
many inventors of great renown.

Ability Score Increase. Your Intelligence score increases by 2, and your Constitution score
increases by 1.

Alignment. Gnomish culture also values kindness and harmony. Many culturally gnomish people work
to uphold harmonious relations or apply their ingenuity to better their fellows, often as sages,
engineers, researchers, scholars, investigators, or inventors. Others take a more personal
approach to these values, becoming minstrels, tricksters, wanderers, or fanciful jewelers.
Those raised among gnomish society are generally good-hearted, and even the tricksters among
them are more playful than vicious.

Artificer’s Lore. Whenever you make an Intelligence (History) check related to magic items,
alchemical objects, or technological devices, you are considered proficient in the History skill
and add double your proficiency bonus to the check, instead of your normal proficiency bonus.

Languages. You can speak, read, and write Common and Gnomish. The Gnomish language, which uses the
Dwarvish script, is renowned for its technical treatises and its catalogs of knowledge about the
natural world.

Tinker. You have proficiency with artisan’s tools (tinker’s tools). Using those tools, you can
spend 1 hour and 10 gp worth of materials to construct a Tiny clockwork device (AC 5, 1 hp). The
device ceases to function after 24 hours (unless you spend 1 hour repairing it to keep the device
functioning), or when you use your action to dismantle it; at that time, you can reclaim the
materials used to create it. You can have up to three such devices active at a time.

When you create a device, choose one of the following options:

Clockwork Toy. This toy is a clockwork animal, monster, or person, such as a frog, mouse, bird,
dragon, or soldier. When placed on the ground, the toy moves 5 feet across the ground on each of
your turns in a random direction. It makes noises as appropriate to the creature it represents.
Fire Starter. The device produces a miniature flame, which you can use to light a candle, torch,
or campfire. Using the device requires your action.
Music Box. When opened, this music box plays a single song at a moderate volume. The box stops
playing when it reaches the song’s end or when it is closed.

Dark Gnome
Source More Ancestries & Cultures, Copyright 2020, Arcanist Press LLP.

High mountain dwellers, worshippers of the spirits of storm and avalanche., which makes
them pariahs.

Ability Score Increase. Your Constitution score increases by 2 and Charisma by 1.

Alignment. Dark gnomish culture reflects the harsh environments in which they choose to live. Most
folk in these communities have little pity or sympathy for anyone who is not contributing to the
community. As such, they tend somewhat away from goodness.

Dark Gnome Magic. When you reach 3rd level, you can cast the fog cloud spell once with this trait.
When you do so, the 27 fog resembles swirling snow. When you reach 5th level, you can cast the
blindness/deafness spell once with this trait. When you do so, the blinded target experiences it
as snow blindness. You regain the ability to cast these spells when you finish a long rest.
Charisma is your spellcasting ability for these spells.

Weapon Focal Training. Dark gnomes train in the use of daggers mixed with the arcane arts. When
you wield a dagger, you may cast the true strike cantrip. Furthermore, whenever you cast a spell,
you may use the dagger as a spellcasting focus.

Languages. You can speak, read, and write Common and Gnomish. The Gnomish language, which uses
the Dwarvish script, is renowned for its technical treatises and its catalogs of knowledge about
the natural world.

Wood Gnome
Source More Ancestries & Cultures, Copyright 2020, Arcanist Press LLP.

Wood gnomish culture revolves around the connection to the forests in which they live. Whereas
rock gnomish cultures value ingenuity and craft, wood gnomish communities tend to value harmony
with and the comprehension of nature.

Ability Score Increase. Your Intelligence score increases by 2 and Dexterity by 1.

Alignment. Gnomish culture values kindness and harmony. Many culturally gnomish people work to
uphold harmonious relations with each other and their environments, serving as caregivers of
their fellows and stewards of the natural world.

Arborist’s Lore. Whenever you make an Intelligence (Nature) check related to the forest or
its creatures, you can add twice your proficiency bonus, instead of any proficiency bonus you
normally apply.

Languages. You can speak, read, and write Common and Gnomish. The Gnomish language, which uses the
Dwarvish script, is renowned for its technical treatises and its catalogs of knowledge about the
natural world.

Herbalist. You have proficiency with the herbalism kit. Using the kit, you can spend 1 day and
25 gp worth of materials to concoct either an antitoxin or a basic potion of healing.


Halfling
The origins of halfling ancestry are a mystery, though tales in halfling culture mention that their
forbearers wandered far and wide before settling down into small pastoral communities.

Contents [hide]

1 Ancestral Traits
2 Cultural Traits
2.1 Lightfoot Halfling
2.2 Sturdy Halfling
2.3 Urban Halfling
Ancestral Traits
Your halfling character has a number of traits in common with all other halflings, regardless of
culture.

Age. A halfling reaches adulthood at the age of 20 and generally lives into the middle of their
second century.

Halfling Nimbleness. You can move through the space of any creature that is of a size larger than
yours.

Lucky. When you roll a 1 on the d20 for an attack roll, ability check, or saving throw, you can
reroll the die and must use the new roll.

Naturally Stealthy. You can attempt to hide even when you are obscured only by a creature that is
at least one size larger than you.

Size. Halflings average about 3 feet tall and weigh about 40 pounds. Your size is Small.

Speed. Your base walking speed is 25 feet.

Cultural Traits
Lightfoot Halfling
Lightfoot halfling culture is warm and welcoming, placing value in hospitality and good
neighborliness. Those who grew up among halflings often make good comrades and allies.

Ability Score Increase. Your Dexterity score increases by 2, and your Charisma score increases by 1.

Alignment. Halfling society also tends toward neatness, both in their physical spaces and in their
social relations. As a rule, they are good-hearted and kind, hate to see others in pain, and have
no tolerance for oppression. They are also orderly and traditional, leaning heavily on the support
of their community and the comfort of their old ways.

Brave. You have advantage on saving throws against being frightened.

Languages. You can speak, read, and write Common and Halfling. The Halfling language isn’t secret,
but members of halfling culture are loath to share it with others. They write very little, so they
don’t have a rich body of literature. Their oral tradition, however, is very strong. Almost all
people in halfling societies speak Common to converse with the people in whose lands they dwell
or through which they are traveling.

Sturdy Halfling
Source More Ancestries & Cultures, Copyright 2020, Arcanist Press LLP.

Sturdy halfling culture can be as warm and friendly as lightfoot halfling culture, but they often
also adhere to dwarven cultural practices in addition to halfling ones.

Ability Score Increase. Your Dexterity score increases by 2 and Constitution by 1.

Alignment. Halfling society also tends toward neatness, both in their physical spaces and in the
social relations. As a rule, they are good-hearted and kind, hate to see others in pain, and have
no tolerance for oppression. They are also orderly and traditional, leaning heavily on the support
of their community and the comfort of their old ways.

Artisan Brewers. Sturdy halfling culture marks the passing of holidays and seasons with special
brews of ale, stout, and spirits. From a young age, people raised in sturdy halfling culture
sample these artisanal brews. You have advantage on saving throws against poison.

Tool Proficiency. You gain proficiency with the artisan’s tools of your choice: smith’s tools,
brewer’s supplies, mechanic’s tools, or mason’s tools.

Languages. You can speak, read, and write Common and Halfling. The Halfling language isn’t secret,
but members of halfling culture are loath to share it with others. They write very little, so they
don’t have a rich body of literature. Their oral tradition, however, is very strong. Almost all
halflings speak Common to converse with the people in whose lands they dwell or through which
they are traveling.

Urban Halfling
Source More Ancestries & Cultures, Copyright 2020, Arcanist Press LLP.

Urban halfling neighborhoods spring up in large towns and cities with some regularity. Rather than
living in grassy hills, tending their gardens, and puffing pipes, urban halfling communities hock
wares at the market, grow networks of contacts and customers, and prefer snuff tobacco. Urban
halfling communities tend to be who work hard and celebrate with as much intensity.

Ability Score Increase. Your Charisma score increases by 2 and Dexterity by 1.

Alignment. Urban halfling community members look out for one another, but they also recognize
that each person has to work to support themselves and their kin as well. In general, those who
grow up in urban halfling communities tend toward neutrality.

Artful Dodgers. Those who grow up in urban halfling neighborhoods surrounded by larger folk get
used to getting out of way of others, either through agility or smooth words. You have proficiency
in either the Acrobatics or the Persuasion skill.

Mercantile. You gain proficiency with your choice of artisan tools, usually studying under one
of the guildmasters of the community and working to sell the guild’s wares at the market.

Languages. You can speak, read, and write Common and Halfling.

Human
Historians report that humans developed fairly recently, compared to many other ancestries.
Despite their relative novelty, those of human ancestry have spread across the land and
established human communities virtually everywhere.

Contents [show]

Ancestral Traits
Your human character has a few traits in common with all other humans, regardless of their
upbringing.

Age. Humans reach adulthood in their late teens and live less than a century.

Curiosity. Your natural curiosity leads you to dabble in a variety of activities. You gain
proficiency in a skill of your choice, as well as with an artisan tool of your choice.

Size. Humans vary widely in height and build, from barely 5 feet to well over 6 feet tall.
Regardless of your position in that range, your size is Medium.

Speed. Your base walking speed is 30 feet.

Cultural Traits

Human culture is defined by its curiosity and love of novelty. As such, its members vary widely,
adopting new practices more frequently than those of other cultures often do.

Ability Score Increase. Your ability scores each increase by 1.

Alignment. Those raised in human cultures tend toward no particular alignment, just as human
cultures themselves tend to change and vary as well. The best and the worst are found among them.

Languages. You can speak, read, and write Common and one extra language of your choice. Human
communities typically learn the languages that its members brought from their own heritages.
Because so many elves and dwarves live among humans, for example, members of human society are
fond of sprinkling their speech with words borrowed from other tongues: Orcish curses, Elvish
musical expressions, Dwarvish military phrases, and so on.

Human Variations
If players find human culture uninspired, GMs can allow players to create humans with fewer
ability score increases in exchange for some other benefit, such as a feat. Such characters would
have two different ability scores of the player’s choice increase by one and gain a feat,
such as Grappler.

Human Paragon
Source More Ancestries & Cultures, Copyright 2020, Arcanist Press LLP.

Paragons are a distinct human culture that claims it originates in a community of legendary heroes
a thousand or more years ago. Over the generations, they have passed down the tales and values of
those epic heroes in tales, practices, and beliefs. These communities welcome others into their
number who are willing to take up the values and commitments that they hold dear. Thus most
members of paragon communities have the following traits.

Ability Score Increase. Your ability scores each increase by 1.

Alignment. Members of paragon communities trumpet the values of duty, honor, and sacrifice they
claim the legendary heroes exemplified. As such, they tend to be lawful.

Heroic Conviction. The beliefs and practices of paragon communities endow its members with bravery
and fortitude. You have advantage on saving throws against being frightened.

Languages. You can speak, read, and write Common, Celestial, and a language of your choice.

Orc

Those of orcish ancestry tell tales tracing their origins to their primary god, though the details
are not included in orcish myth. Indeed, some scholars of orcish ancestry or culture even claim
that the orcish ancestors came from a faraway world.

Ancestral Traits
There are people of orcish ancestry who can be found outside of the secluded, often remote
orcish communities.

Age. Orcs mature a little faster than humans, reaching adulthood around age 14. They live
to be about 75.

Size. Orcs are somewhat larger and bulkier than humans, and they range from 5 to well over 6 feet
tall. Your size is Medium.

Speed. Your base walking speed is 30 feet.

Darkvision. Thanks to your orcish ancestry, you have superior vision in dark and dim conditions.
You can see in dim light within 60 feet of you as if it were bright light, and in darkness as if
it were dim light. You can’t discern color in darkness, only shades of gray.

Relentless Endurance. When you are reduced to 0 hit points but not killed outright, you can drop
to 1 hit point instead. You can’t use this feature again until you finish a long rest.

Cultural Traits

Some orcish communities exhibit a traditional culture, one that values physical ability,
competition, and confidence. Others embrace technology and mechanical innovation. Orcish society
is often familial and matriarchal, with a focus on providing for the community, especially via
hunting, military training, or the construction of homes.

Ability Score Increase. Your Strength score increases by 2, and your Constitution score increases
by 1.

Alignment. Orcish cultures tend toward a live-and-let-live worldview. People raised among orcs
are not as often lawful, tending instead toward a more relaxed attitude.

Confident. You gain proficiency in the Intimidation skill.

Powerful Attacks. When you score a critical hit with a melee weapon attack, you can roll one of
the weapon’s damage dice one additional time and add it to the extra damage of the critical hit.

Languages. You can speak, read, and write Common and Orcish. Orcish is a guttural language with
hard consonants. It is one of several languages written in the Dwarvish script.

Tiefling

Tiefling heritage is often credited to humans who entered into a fiendish pact with a demon or
devil. Usually, however, those of tiefling ancestry have no connection to this event in their
lineage.

Ancestral Traits
Tieflings share certain ancestral traits as a result of their infernal descent, whether inherited
from a parent or from a more distant ancestor.

Age. Tieflings mature at the same rate as humans but live a few years longer.

Size. Tieflings are about the same size and build as humans. Your size is Medium.

Speed. Your base walking speed is 30 feet.

Darkvision. Thanks to your infernal ancestry, you have superior vision in dark and dim conditions.
You can see in dim light within 60 feet of you as if it were bright light, and in darkness as if
it were dim light. You can’t discern color in darkness, only shades of gray.

Hellish Resistance. You have resistance to fire damage.

Cultural Traits
Predominantly tiefling communities are rare. Most tieflings belong to other cultures, as the
tiefling heritage is not reliably inherited from generation to generation, particularly when
couples of diverse ancestry have children. The tiefling societies that do exist, however, often
embrace their infernal heritage and make it their own, which leads them to become more comfortable
with their identities.

Ability Score Increase. Your Intelligence score increases by 1, and your Charisma score
increases by 2.

Alignment. Tieflings do not have an innate tendency toward evil, though many non-tieflings falsely
believe they do. Evil or not, an independent nature inclines many in tiefling culture toward a
chaotic alignment.

Infernal Legacy. You know the thaumaturgy cantrip. When you reach 3rd level, you can cast the
hellish rebuke spell as a 2nd-level spell once with this trait and regain the ability to do so
when you finish a long rest. When you reach 5th level, you can cast the darkness spell once with
this trait and regain the ability to do so when you finish a long rest. Charisma is your
spellcasting ability for these spells.

Languages. You can speak, read, and write Common and Infernal.



*/
